{% load static %}

<script>
    {% include "rsshistory/javascript_list_utilities.js" %}

    let currentUserSearchSuggestions = 0;

    function loadUserSearchSuggestions(search_term, attempt = 1) {
        if (!search_term)
        {
            return;
        }

        let requestVersion = ++currentUserSearchSuggestions;

        $.ajax({
            url: '{% url 'rsshistory:get-search-suggestions-entries' "placeholder" %}'.replace("placeholder", search_term),
            type: 'GET',
            timeout: 15000,
            success: function(data) {
                if (requestVersion === currentUserSearchSuggestions) {
                    $('#searchHistory').collapse('hide');
                    $('#searchSuggestions').empty();
                    fillUserSearchSuggestions(data.items);
                    $('#searchSuggestions').collapse('show');
                }
            },
            error: function(xhr, status, error) {
                if (attempt < 3) {
                    $('#searchSuggestions').html("Cannot load suggestions, retry");
				    $('#searchSuggestions').collapse('show');
				   
					loadUserSearchSuggestions(search_term, attempt + 1); 
                }
				else {
                    $('#searchSuggestions').html("Cannot load suggestions");
				    $('#searchSuggestions').collapse('show');
				}
            }
        });
    }

    function loadUserSearchHistory(attempt = 1) {
        $.ajax({
            url: '{% url 'rsshistory:get-user-search-history' %}',
            type: 'GET',
            timeout: 15000,
            success: function(data) {
                $('#searchHistory').html(data);
            },
            error: function(xhr, status, error) {
                if (attempt < 3) {
                    loadUserSearchHistory(search_term, page, attempt + 1);
                    $('#searchHistory').html("Error loading dynamic content, retry");
                }
                else {
                    $('#searchHistory').html("Cannot load data from " + url)
                }
            }
        });
    }

    function entryStandardTemplate(entry, show_icons = true, small_icons = false) {
        let page_rating_votes = entry.page_rating_votes;

        let badge_text = page_rating_votes > 0 ? `
            <span class="badge text-bg-warning" style="position: absolute; top: 5px; right: 20px; font-size: 1rem;">
                ${page_rating_votes}
            </span>` : '';

        let star_badge = entry.bookmarked ? `
            <span class="badge text-bg-warning" style="position: absolute; top: 5px; right: 5px; font-size: 1rem;">
                ★
            </span>` : '';

        let thumbnail_text = '';
        if (show_icons) {
            const iconClass = small_icons ? 'icon-small' : 'icon-normal';
            thumbnail_text = `<img src="{thumbnail}" class="rounded ${iconClass}" />`;
        }
        
        if (thumbnail_text) {
            thumbnail_text = `
                <div style="position: relative; display: inline-block;">
                    ${thumbnail_text}
                    ${badge_text}
                    ${star_badge}
                </div>`;
        }

        return `
            <a 
                href="{link_absolute}"
                title="{title}"
                class="my-1 p-1 list-group-item list-group-item-action"
            >
                <div class="d-flex">
                    ${thumbnail_text}
                    <div class="mx-2">
                        <span style="font-weight:bold" class="text-reset">{title_safe} [${page_rating_votes}]</span>
                        <div class="text-reset">
                            {source__title} {date_published}
                        </div>
                    </div>
                </div>
            </a>
        `;
    }

    function entrySearchEngineTemplate(entry, show_icons = true, small_icons = false) {
        let page_rating_votes = entry.page_rating_votes;

        let badge_text = page_rating_votes > 0 ? `
            <span class="badge text-bg-warning" style="position: absolute; top: 5px; right: 20px; font-size: 1rem;">
                ${page_rating_votes}
            </span>` : '';

        let star_badge = entry.bookmarked ? `
            <span class="badge text-bg-warning" style="position: absolute; top: 5px; right: 5px; font-size: 1rem;">
                ★
            </span>` : '';

        let thumbnail_text = '';
        if (show_icons) {
            const iconClass = small_icons ? 'icon-small' : 'icon-normal';
            thumbnail_text = `
                <div style="position: relative; display: inline-block;">
                    <img src="{thumbnail}" class="rounded ${iconClass}"/>
                    ${badge_text}
                    ${star_badge}
                </div>`;
        }

        return `
            <a 
                href="{link_absolute}"
                title="{title}"
                class="my-1 p-1 list-group-item list-group-item-action"
            >
                ${thumbnail_text}
                <span style="font-weight:bold" class="text-reset">{title_safe} [${page_rating_votes}]</span>
                <div class="text-reset">@ {link}</div>
            </a>
        `;
    }

    function entryGalleryTemplate(entry, show_icons = true, small_icons = false) {
        let page_rating_votes = entry.page_rating_votes;
        
        let badge_text = page_rating_votes > 0 ? `
            <span class="badge text-bg-warning" style="position: absolute; top: 5px; right: 30px; font-size: 1rem;">
                ${page_rating_votes}
            </span>` : '';

        let star_badge = entry.bookmarked ? `
            <span class="badge text-bg-warning" style="position: absolute; top: 5px; right: 5px; font-size: 1rem;">
                ★
            </span>` : '';

        let thumbnail = entry.thumbnail;
        let thumbnail_text = `
            <div style="position: relative; display: inline-block; width: 100%; max-height: 100%;">
                <img src="${thumbnail}" style="width:100%; max-height:100%; object-fit:cover"/>
                ${badge_text}
                ${star_badge}
            </div>
        `;

        return `
            <a 
                href="{link_absolute}"
                title="{title}"
                class="element_${view_display_type} list-group-item list-group-item-action"
            >
                <div style="display: flex; flex-direction:column; align-content:normal; height:100%">
                    <div style="flex: 0 0 70%; flex-shrink: 0;flex-grow:0;max-height:70%">
                        ${thumbnail_text}
                    </div>
                    <div style="flex: 0 0 30%; flex-shrink: 0;flex-grow:0;max-height:30%">
                        <span style="font-weight: bold" class="text-primary">{title_safe}</span>
                        <div class="link-list-item-description">{source__title}</div>
                    </div>
                </div>
            </a>
        `;
    }

    function fillEntryList(entries) {
        let htmlOutput = '';

        if (entries && entries.length > 0) {
            entries.forEach(entry => {
                let datePublished = new Date(entry.date_published);
                if (isNaN(datePublished)) {
                    datePublished = new Date();
                }

                const templateMap = {
                    "standard": entryStandardTemplate,
                    "gallery": entryGalleryTemplate,
                    "search-engine": entrySearchEngineTemplate
                };

                const templateFunc = templateMap[view_display_type];
                if (!templateFunc) {
                    return;
                }
                var template_text = templateFunc(entry, view_show_icons, view_small_icons);

                let thumbnail = entry.thumbnail;
                let page_rating_votes = entry.page_rating_votes;
                let page_rating_contents = entry.page_rating_contents;

                // Replace all occurrences of the placeholders using a global regular expression
                let listItem = template_text
                    .replace(/{link_absolute}/g, entry.link_absolute)
                    .replace(/{link}/g, entry.link)
                    .replace(/{title}/g, entry.title)
                    .replace(/{thumbnail}/g, entry.thumbnail)
                    .replace(/{title_safe}/g, entry.title_safe)
                    .replace(/{page_rating_votes}/g, entry.page_rating_votes)
                    .replace(/{page_rating_contents}/g, entry.page_rating_contents)
                    .replace(/{page_rating}/g, entry.page_rating)
                    .replace(/{source__title}/g, entry.source__title)
                    .replace(/{date_published}/g, datePublished.toLocaleString());

                htmlOutput += listItem;
            });
        } else {
            htmlOutput = '<li class="list-group-item">No entries found</li>';
        }

        return htmlOutput;
    }

    function fillListData(data) {
        $('#listData').html("");

        let entries = data.entries;

        if (!entries || entries.length == 0) {
            $('#listData').html("No entries found");
            return;
        }

        var finished_text = fillEntryList(entries);
        $('#listData').html(finished_text);
        let pagination = fillPagination(data);
        $('#pagination').html(pagination);
    }

    $(document).ready(function() {
        var show = getQueryParam('show') || '';
        var auto_refresh = getQueryParam('auto-refresh') || '';
        var search_term = getQueryParam('search') || '';

        var search_term_input = $('#filterForm input[name="search"]').val();
        if (search_term_input)
        {
            loadUserSearchSuggestions(search_term_input);
        }
        loadUserSearchHistory();

        // if (user specified search, or show is true), and entrylist is empty
        if (search_term || show) {
            if (isEmpty($('#listData'))) {
                loadRowListContent();
            }
        }

        //-----------------------------------------------
        // if auto refresh - keep refreshing list - for kiosk mode
        if (auto_refresh && !isNaN(auto_refresh)) {
            setInterval(function() {
                loadRowListContent();
            }, parseInt(auto_refresh));
        }
    });

    //-----------------------------------------------
    $(document).on('click', '.btnFilterTrigger', function(e) {
        e.preventDefault();

        // search if user specified search. pass page also

        var search_term = $(this).data('search') || $('#id_search').val();
        var page = $(this).data('page')

        if ($(this).data('search')) {
            $('#id_search').val(search_term);
        }

        $('#searchSuggestions').collapse('hide');
        $('#searchHistory').collapse('hide');
        $('#searchSyntax').collapse('hide');

        loadRowListContent(search_term, page);
    });

    //-----------------------------------------------
    // Bind to the input event of the search input within the form
    $('#filterForm input[name="search"]').on('input', function() {
        var search_term = $('#filterForm input[name="search"]').val();

        $('#searchSuggestions').empty();
        $('#searchSuggestions').collapse('hide');

        if (search_term) {
            loadUserSearchSuggestions(search_term);
        }
    });
</script>
